<!doctype html>
<html lang="it" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alfabeto Hangul</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&amp;family=Space+Grotesk:wght@400;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
    }
    * {
      font-family: 'Space Grotesk', sans-serif;
    }
    .hangul {
      font-family: 'Noto Sans KR', sans-serif;
    }
    #drawCanvas {
      touch-action: none;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full w-full bg-gradient-to-br from-indigo-950 via-purple-950 to-indigo-950 text-white overflow-auto">
  <div class="h-full w-full"><!-- Header -->
   <header class="sticky top-0 z-50 bg-black/40 backdrop-blur-xl border-b border-purple-500/30">
    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
     <div>
      <h1 id="mainTitle" class="text-xl md:text-3xl font-bold bg-gradient-to-r from-cyan-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">Alfabeto Hangul í•œê¸€</h1>
      <p id="mainSubtitle" class="text-xs md:text-base text-purple-300 mt-1">Impara a scrivere e leggere il coreano</p>
     </div>
     <div class="bg-purple-900/60 px-3 md:px-6 py-2 md:py-3 rounded-xl md:rounded-2xl border border-purple-500/40">
      <div class="text-xs md:text-sm text-purple-300">
       Progressi
      </div>
      <div id="progressDisplay" class="text-lg md:text-2xl font-bold text-cyan-400">
       0%
      </div>
     </div>
    </div>
   </header>
   <main class="max-w-7xl mx-auto px-4 md:px-6 py-6 md:py-10"><!-- Intro Card -->
    <div class="bg-gradient-to-br from-purple-900/50 to-pink-900/50 rounded-2xl md:rounded-3xl p-5 md:p-10 mb-8 md:mb-12 border border-purple-500/30">
     <div class="flex flex-col md:flex-row items-start gap-4 md:gap-8">
      <div class="text-5xl md:text-8xl">
       ğŸ“–
      </div>
      <div class="flex-1">
       <h2 class="text-2xl md:text-4xl font-bold mb-3 md:mb-4 text-cyan-300">Benvenuto!</h2>
       <p id="introDescription" class="text-sm md:text-xl text-purple-100 leading-relaxed mb-4 md:mb-6">L'Hangul (í•œê¸€) Ã¨ l'alfabeto coreano moderno, creato nel 1443 dal Re Sejong il Grande. Ãˆ uno dei sistemi di scrittura piÃ¹ scientifici e logici al mondo, composto da 24 lettere base: 10 vocali e 14 consonanti.</p>
       <div class="grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-4">
        <div class="bg-black/30 rounded-lg md:rounded-xl p-3 md:p-4 border border-cyan-500/30">
         <div class="text-2xl md:text-3xl mb-1 md:mb-2">
          ğŸ”¤
         </div>
         <div class="font-bold text-cyan-300 mb-1 text-sm md:text-base">
          24 Lettere
         </div>
         <div class="text-xs md:text-sm text-purple-200">
          10 vocali + 14 consonanti
         </div>
        </div>
        <div class="bg-black/30 rounded-lg md:rounded-xl p-3 md:p-4 border border-purple-500/30">
         <div class="text-2xl md:text-3xl mb-1 md:mb-2">
          âœï¸
         </div>
         <div class="font-bold text-purple-300 mb-1 text-sm md:text-base">
          Pratica Canvas
         </div>
         <div class="text-xs md:text-sm text-purple-200">
          Disegna ogni lettera
         </div>
        </div>
        <div class="bg-black/30 rounded-lg md:rounded-xl p-3 md:p-4 border border-pink-500/30">
         <div class="text-2xl md:text-3xl mb-1 md:mb-2">
          ğŸ¯
         </div>
         <div class="font-bold text-pink-300 mb-1 text-sm md:text-base">
          Quiz Interattivo
         </div>
         <div class="text-xs md:text-sm text-purple-200">
          Testa le tue conoscenze
         </div>
        </div>
       </div>
      </div>
     </div>
    </div><!-- Navigation Tabs -->
    <div class="flex gap-2 mb-6 md:mb-10 overflow-x-auto pb-2"><button onclick="switchSection('vocali')" data-section="vocali" class="section-tab px-4 md:px-8 py-2 md:py-4 rounded-xl md:rounded-2xl font-bold text-sm md:text-lg transition-all bg-cyan-600 text-white shadow-lg shadow-cyan-500/30 whitespace-nowrap"> ğŸ”¤ Vocali </button> <button onclick="switchSection('consonanti')" data-section="consonanti" class="section-tab px-4 md:px-8 py-2 md:py-4 rounded-xl md:rounded-2xl font-bold text-sm md:text-lg transition-all bg-purple-900/40 text-purple-300 hover:bg-purple-800/60 whitespace-nowrap"> ğŸ—£ï¸ Consonanti </button> <button onclick="switchSection('canvas')" data-section="canvas" class="section-tab px-4 md:px-8 py-2 md:py-4 rounded-xl md:rounded-2xl font-bold text-sm md:text-lg transition-all bg-purple-900/40 text-purple-300 hover:bg-purple-800/60 whitespace-nowrap"> âœï¸ Canvas </button> <button onclick="switchSection('quiz')" data-section="quiz" class="section-tab px-4 md:px-8 py-2 md:py-4 rounded-xl md:rounded-2xl font-bold text-sm md:text-lg transition-all bg-purple-900/40 text-purple-300 hover:bg-purple-800/60 whitespace-nowrap"> ğŸ“ Quiz </button>
    </div><!-- VOCALI SECTION -->
    <section id="section-vocali" class="content-section">
     <h2 class="text-2xl md:text-4xl font-bold mb-4 md:mb-8 text-cyan-300">Le 10 Vocali Base</h2>
     <p class="text-base md:text-xl text-purple-200 mb-4 md:mb-8">Clicca su una lettera per vedere la spiegazione completa</p>
     <div id="vocaliGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 md:gap-6"><!-- Generated by JS -->
     </div>
    </section><!-- CONSONANTI SECTION -->
    <section id="section-consonanti" class="content-section hidden">
     <h2 class="text-2xl md:text-4xl font-bold mb-4 md:mb-8 text-purple-300">Le 14 Consonanti Base</h2>
     <p class="text-base md:text-xl text-purple-200 mb-4 md:mb-8">Clicca su una lettera per vedere la spiegazione completa</p>
     <div id="consonantiGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 md:gap-6"><!-- Generated by JS -->
     </div>
    </section><!-- CANVAS SECTION -->
    <section id="section-canvas" class="content-section hidden">
     <div class="grid lg:grid-cols-4 gap-8"><!-- Letter selector -->
      <div class="lg:col-span-1">
       <div class="bg-purple-900/30 rounded-2xl p-6 border border-purple-500/30 sticky top-24">
        <h3 class="text-xl font-bold mb-4 text-cyan-300">Seleziona Lettera</h3>
        <div id="canvasLetterList" class="space-y-2 max-h-96 overflow-y-auto pr-2"><!-- Generated by JS -->
        </div>
       </div>
      </div><!-- Canvas area -->
      <div class="lg:col-span-3">
       <div class="bg-gradient-to-br from-purple-900/50 to-pink-900/50 rounded-3xl p-8 border border-purple-500/30">
        <div class="flex justify-between items-start mb-6">
         <div class="flex items-center gap-6">
          <div id="canvasLetterDisplay" class="hangul text-9xl font-black text-cyan-400">
           ã…
          </div>
          <div>
           <div id="canvasLetterRoman" class="text-4xl font-bold text-purple-300 mb-2">
            a
           </div>
           <div id="canvasLetterSound" class="text-xl text-purple-200 mb-1">
            Come "a" in casa
           </div>
           <div id="canvasLetterExample" class="text-lg text-cyan-300 italic">
            Es: ì•„ë¹  (appa) = papÃ 
           </div>
          </div>
         </div><button onclick="clearDrawing()" class="px-6 py-3 bg-pink-600 hover:bg-pink-500 rounded-xl font-bold text-lg transition-all"> ğŸ—‘ï¸ Cancella </button>
        </div>
        <div class="bg-white rounded-2xl shadow-2xl mx-auto" style="width: 100%; max-width: 600px; aspect-ratio: 1; position: relative;">
         <canvas id="guideCanvas" class="absolute inset-0 w-full h-full rounded-2xl"></canvas>
         <canvas id="drawCanvas" class="absolute inset-0 w-full h-full rounded-2xl cursor-crosshair"></canvas>
        </div>
        <div class="mt-6 text-center">
         <p class="text-lg text-cyan-300">ï¿½ï¿½ï¿½ <strong>Suggerimento:</strong> Segui la guida grigia per tracciare la lettera correttamente</p>
        </div>
       </div>
      </div>
     </div>
    </section><!-- QUIZ SECTION -->
    <section id="section-quiz" class="content-section hidden">
     <div class="max-w-3xl mx-auto">
      <div class="bg-gradient-to-br from-purple-900/50 to-pink-900/50 rounded-2xl md:rounded-3xl p-6 md:p-10 border border-purple-500/30">
       <h2 class="text-2xl md:text-4xl font-bold mb-2 md:mb-3 text-center text-cyan-300">Quiz Hangul ğŸ“</h2>
       <p class="text-base md:text-xl text-purple-200 text-center mb-6 md:mb-10">Quale suono rappresenta questa lettera?</p>
       <div class="text-center mb-6 md:mb-10">
        <div class="inline-block bg-gradient-to-br from-cyan-600 to-purple-600 rounded-2xl md:rounded-3xl p-10 md:p-20 shadow-2xl border-2 md:border-4 border-cyan-400/50">
         <div id="quizLetter" class="hangul text-6xl md:text-9xl font-black text-white">
          ã…
         </div>
        </div>
       </div>
       <div id="quizOptionsContainer" class="grid grid-cols-2 gap-3 md:gap-5 mb-6 md:mb-8"><!-- Generated by JS -->
       </div>
       <div id="quizFeedbackContainer" class="hidden mb-6 md:mb-8 text-center">
        <div id="quizFeedbackMessage" class="text-2xl md:text-4xl font-bold mb-3 md:mb-4"></div>
        <div id="quizFeedbackDetail" class="text-sm md:text-xl text-purple-200 mb-4 md:mb-6"></div><button onclick="loadNextQuiz()" class="px-6 md:px-10 py-3 md:py-4 bg-gradient-to-r from-cyan-600 to-purple-600 hover:from-cyan-500 hover:to-purple-500 rounded-xl md:rounded-2xl font-bold text-base md:text-xl transition-all shadow-lg"> Prossima Domanda â†’ </button>
       </div>
       <div class="flex justify-center gap-8 md:gap-16 pt-6 md:pt-8 border-t border-purple-500/30">
        <div class="text-center">
         <div id="quizCorrectScore" class="text-4xl md:text-6xl font-black text-green-400">
          0
         </div>
         <div class="text-sm md:text-lg text-purple-300 mt-1 md:mt-2">
          Corrette âœ…
         </div>
        </div>
        <div class="text-center">
         <div id="quizWrongScore" class="text-4xl md:text-6xl font-black text-red-400">
          0
         </div>
         <div class="text-sm md:text-lg text-purple-300 mt-1 md:mt-2">
          Sbagliate âŒ
         </div>
        </div>
       </div>
      </div>
     </div>
    </section>
   </main><!-- MODAL FOR LETTER DETAILS -->
   <div id="letterModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 md:p-6 bg-black/80 backdrop-blur-sm">
    <div class="bg-gradient-to-br from-purple-900 to-pink-900 rounded-2xl md:rounded-3xl p-6 md:p-10 max-w-2xl w-full border-2 border-cyan-500/50 shadow-2xl relative max-h-[90vh] overflow-y-auto"><button onclick="closeLetterModal()" class="absolute top-4 right-4 md:top-6 md:right-6 text-3xl md:text-4xl text-purple-300 hover:text-white transition-colors">Ã—</button>
     <div class="text-center mb-6 md:mb-8">
      <div id="modalLetter" class="hangul text-6xl md:text-9xl font-black text-cyan-400 mb-3 md:mb-4">
       ã…
      </div>
      <div id="modalRoman" class="text-3xl md:text-5xl font-bold text-purple-300 mb-2 md:mb-3">
       a
      </div>
     </div>
     <div class="space-y-4 md:space-y-6 mb-6 md:mb-8">
      <div class="bg-black/30 rounded-xl md:rounded-2xl p-4 md:p-6 border border-cyan-500/30">
       <div class="text-cyan-300 font-bold text-base md:text-lg mb-2">
        ğŸ”Š Pronuncia
       </div>
       <div id="modalSound" class="text-base md:text-xl text-purple-100">
        Come la "a" in casa
       </div>
      </div>
      <div class="bg-black/30 rounded-xl md:rounded-2xl p-4 md:p-6 border border-purple-500/30">
       <div class="text-purple-300 font-bold text-base md:text-lg mb-2">
        ğŸ“ Spiegazione
       </div>
       <div id="modalExplanation" class="text-base md:text-xl text-purple-100">
        Questa Ã¨ la vocale base "a".
       </div>
      </div>
      <div class="bg-black/30 rounded-xl md:rounded-2xl p-4 md:p-6 border border-pink-500/30">
       <div class="text-pink-300 font-bold text-base md:text-lg mb-2">
        ğŸ’¬ Esempio
       </div>
       <div id="modalExample" class="text-base md:text-xl text-purple-100 italic">
        ì•„ë¹  (appa) = papÃ 
       </div>
      </div>
      <div class="bg-black/30 rounded-xl md:rounded-2xl p-4 md:p-6 border border-yellow-500/30">
       <div class="text-yellow-300 font-bold text-base md:text-lg mb-3">
        â­ Livello di Padronanza
       </div>
       <div id="modalMastery" class="flex justify-center gap-2 md:gap-3 text-3xl md:text-5xl"><span>ï¿½ï¿½ï¿½</span><span>â˜†</span><span>â˜†</span>
       </div>
      </div>
     </div><button onclick="practiceLetterFromModal()" class="w-full py-3 md:py-5 bg-gradient-to-r from-cyan-600 to-purple-600 hover:from-cyan-500 hover:to-purple-500 rounded-xl md:rounded-2xl font-bold text-base md:text-xl transition-all shadow-lg"> âœï¸ Pratica Questa Lettera </button>
    </div>
   </div>
  </div>
  <script>
    // DATA
    const vocali = [
      { id: 'v1', char: 'ã…', roman: 'a', sound: 'Come "a" in casa', explanation: 'Vocale base. Si scrive con una linea verticale e un trattino orizzontale a destra. Rappresenta il suono "ah".', example: 'ì•„ë¹  (appa) = papÃ ' },
      { id: 'v2', char: 'ã…“', roman: 'eo', sound: 'Tra "o" aperta e "e"', explanation: 'Vocale intermedia. Linea verticale con trattino a sinistra. Suono simile alla "o" molto aperta.', example: 'ì–´ë¨¸ë‹ˆ (eomeoni) = madre' },
      { id: 'v3', char: 'ã…—', roman: 'o', sound: 'Come "o" chiusa', explanation: 'Vocale "o". Linea orizzontale con trattino verticale sotto. Suono come "oh".', example: 'ì˜¤ë¹  (oppa) = fratello maggiore' },
      { id: 'v4', char: 'ã…œ', roman: 'u', sound: 'Come "u" in uva', explanation: 'Vocale "u". Linea orizzontale con trattino verticale sopra. Suono come "oo" in inglese "food".', example: 'ìš°ìœ  (uyu) = latte' },
      { id: 'v5', char: 'ã…¡', roman: 'eu', sound: 'Suono gutturale neutro', explanation: 'Vocale neutra. Solo linea orizzontale. Suono simile a una "e" muta pronunciata con la bocca piatta.', example: 'ìœ¼ìŒ (eu-eum) = hmm' },
      { id: 'v6', char: 'ã…£', roman: 'i', sound: 'Come "i" in idea', explanation: 'Vocale "i". Solo linea verticale. Suono come "ee" in inglese "see".', example: 'ì´ (i) = questo/questa' },
      { id: 'v7', char: 'ã…', roman: 'ae', sound: 'Come "e" aperta', explanation: 'Vocale composta. ã… con un trattino extra. Suono come "e" aperta in "bello".', example: 'ì•  (ae) = bambino' },
      { id: 'v8', char: 'ã…”', roman: 'e', sound: 'Come "e" chiusa', explanation: 'Vocale composta. ã…“ con un trattino extra. Suono come "e" in "perchÃ©".', example: 'ì— (e) = a, in (particella)' },
      { id: 'v9', char: 'ã…‘', roman: 'ya', sound: 'Come "ia" veloce', explanation: 'Vocale composta. ã… con due trattini a destra. Suono come "ya" in "yacht".', example: 'ì•¼êµ¬ (yagu) = baseball' },
      { id: 'v10', char: 'ã…•', roman: 'yeo', sound: 'Come "io" veloce', explanation: 'Vocale composta. ã…“ con due trattini a sinistra. Suono come "yo" in "yogurt".', example: 'ì—¬ì (yeoja) = donna' }
    ];

    const consonanti = [
      { id: 'c1', char: 'ã„±', roman: 'g/k', sound: 'Tra "g" e "k"', explanation: 'Consonante base. Rappresenta la forma della lingua contro il palato. Suona come "g" dolce o "k" a seconda della posizione.', example: 'ê°€ë‹¤ (gada) = andare' },
      { id: 'c2', char: 'ã„´', roman: 'n', sound: 'Come "n" in nave', explanation: 'Consonante nasale. Forma della lingua contro i denti. Suono identico alla "n" italiana.', example: 'ë‚˜ (na) = io' },
      { id: 'c3', char: 'ã„·', roman: 'd/t', sound: 'Tra "d" e "t"', explanation: 'Consonante dentale. Forma della lingua contro i denti superiori. Suona come "d" o "t" morbida.', example: 'ë‹¤ë¦¬ (dari) = gamba/ponte' },
      { id: 'c4', char: 'ã„¹', roman: 'r/l', sound: 'Tra "r" e "l"', explanation: 'Consonante liquida. La lingua vibra leggermente. Suono intermedio tra "r" e "l".', example: 'ë¼ë©´ (ramyeon) = ramen' },
      { id: 'c5', char: 'ã…', roman: 'm', sound: 'Come "m" in mare', explanation: 'Consonante nasale labiale. Rappresenta la forma della bocca chiusa. Suono identico alla "m" italiana.', example: 'ë¬¼ (mul) = acqua' },
      { id: 'c6', char: 'ã…‚', roman: 'b/p', sound: 'Tra "b" e "p"', explanation: 'Consonante labiale. Rappresenta la forma delle labbra. Suona come "b" morbida o "p".', example: 'ë°¥ (bap) = riso cotto' },
      { id: 'c7', char: 'ã……', roman: 's', sound: 'Come "s" in sole', explanation: 'Consonante sibilante. Forma dei denti. Suono come "s" italiana, a volte "sh" prima di "i".', example: 'ì‚¬ë‘ (sarang) = amore' },
      { id: 'c8', char: 'ã…‡', roman: 'ng/-', sound: 'Silenzioso o "ng"', explanation: 'Consonante speciale. All\'inizio Ã¨ muta, alla fine suona come "ng". Rappresenta la gola aperta.', example: 'ì•ˆë…• (annyeong) = ciao' },
      { id: 'c9', char: 'ã…ˆ', roman: 'j', sound: 'Come "g" dolce', explanation: 'Consonante affricata. Forma simile a ã…… ma piÃ¹ complessa. Suono come "j" inglese o "g" dolce.', example: 'ìë‹¤ (jada) = dormire' },
      { id: 'c10', char: 'ã…Š', roman: 'ch', sound: 'Come "c" in ciao', explanation: 'Consonante affricata aspirata. ã…ˆ con trattino extra. Suono come "ch" italiano.', example: 'ì°¨ (cha) = tÃ¨/automobile' },
      { id: 'c11', char: 'ã…‹', roman: 'k', sound: 'K aspirata forte', explanation: 'Consonante aspirata. ã„± con trattino extra. Suono come "k" molto forte e aspirata.', example: 'ì»¤í”¼ (keopi) = caffÃ¨' },
      { id: 'c12', char: 'ã…Œ', roman: 't', sound: 'T aspirata forte', explanation: 'Consonante aspirata. ã„· con trattino extra. Suono come "t" molto forte e aspirata.', example: 'í‹° (ti) = maglietta' },
      { id: 'c13', char: 'ã…', roman: 'p', sound: 'P aspirata forte', explanation: 'Consonante aspirata. ã…‚ con trattino extra. Suono come "p" molto forte e aspirata.', example: 'í”¼ì (pija) = pizza' },
      { id: 'c14', char: 'ã…', roman: 'h', sound: 'H aspirata', explanation: 'Consonante aspirata. Rappresenta il respiro. Suono come "h" inglese aspirata.', example: 'í•˜ë‚˜ (hana) = uno' }
    ];

    const allLetters = [...vocali, ...consonanti];

    // STATE
    let userData = [];
    let currentCanvasLetter = vocali[0];
    let currentModalLetter = null;
    let currentQuizLetter = null;
    let quizCorrect = 0;
    let quizWrong = 0;
    let isDrawing = false;
    let drawCanvas, drawCtx, guideCanvas, guideCtx;

    // CONFIG
    const defaultConfig = {
      app_title: 'Alfabeto Hangul í•œê¸€',
      intro_text: 'L\'Hangul (í•œê¸€) Ã¨ l\'alfabeto coreano moderno, creato nel 1443 dal Re Sejong il Grande. Ãˆ uno dei sistemi di scrittura piÃ¹ scientifici e logici al mondo, composto da 24 lettere base: 10 vocali e 14 consonanti.',
      bg_color: '#1e1b4b',
      surface_color: '#581c87',
      text_color: '#e9d5ff',
      primary_color: '#22d3ee',
      accent_color: '#ec4899'
    };

    // ELEMENT SDK
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (config) => {
          document.getElementById('mainTitle').textContent = config.app_title || defaultConfig.app_title;
          document.getElementById('introDescription').textContent = config.intro_text || defaultConfig.intro_text;
        },
        mapToCapabilities: (config) => ({
          recolorables: [
            { get: () => config.bg_color || defaultConfig.bg_color, set: (v) => { config.bg_color = v; window.elementSdk.setConfig({ bg_color: v }); }},
            { get: () => config.surface_color || defaultConfig.surface_color, set: (v) => { config.surface_color = v; window.elementSdk.setConfig({ surface_color: v }); }},
            { get: () => config.text_color || defaultConfig.text_color, set: (v) => { config.text_color = v; window.elementSdk.setConfig({ text_color: v }); }},
            { get: () => config.primary_color || defaultConfig.primary_color, set: (v) => { config.primary_color = v; window.elementSdk.setConfig({ primary_color: v }); }},
            { get: () => config.accent_color || defaultConfig.accent_color, set: (v) => { config.accent_color = v; window.elementSdk.setConfig({ accent_color: v }); }}
          ],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ['app_title', config.app_title || defaultConfig.app_title],
          ['intro_text', config.intro_text || defaultConfig.intro_text]
        ])
      });
    }

    // DATA SDK
    const dataHandler = {
      onDataChanged(data) {
        userData = data;
        updateProgressDisplay();
        renderAllLetterCards();
      }
    };

    async function initializeApp() {
      if (window.dataSdk) {
        const result = await window.dataSdk.init(dataHandler);
        if (!result.isOk) {
          console.error('Data SDK init failed');
        }
      }
      renderAllLetterCards();
      setupCanvas();
      loadNextQuiz();
    }

    function getLetterMastery(letterId) {
      const record = userData.find(r => r.letter_id === letterId);
      return record ? record.mastery_level : 0;
    }

    async function updateLetterMastery(letterId, wasCorrect) {
      if (!window.dataSdk) return;

      const existing = userData.find(r => r.letter_id === letterId);

      if (existing) {
        const newMastery = wasCorrect 
          ? Math.min(3, existing.mastery_level + 1) 
          : Math.max(0, existing.mastery_level - 1);

        await window.dataSdk.update({
          ...existing,
          mastery_level: newMastery,
          times_practiced: existing.times_practiced + 1,
          last_practiced: new Date().toISOString()
        });
      } else {
        if (userData.length >= 999) return;

        await window.dataSdk.create({
          letter_id: letterId,
          mastery_level: wasCorrect ? 1 : 0,
          times_practiced: 1,
          last_practiced: new Date().toISOString()
        });
      }
    }

    function updateProgressDisplay() {
      const totalLetters = allLetters.length;
      const masteredLetters = userData.filter(r => r.mastery_level >= 2).length;
      const percentage = Math.round((masteredLetters / totalLetters) * 100);
      document.getElementById('progressDisplay').textContent = `${percentage}%`;
    }

    // RENDER LETTER CARDS
    function renderAllLetterCards() {
      renderLetterCards('vocaliGrid', vocali);
      renderLetterCards('consonantiGrid', consonanti);
      renderCanvasLetterList();
    }

    function renderLetterCards(containerId, letters) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';

      letters.forEach(letter => {
        const mastery = getLetterMastery(letter.id);
        const stars = 'â­'.repeat(mastery) + 'â˜†'.repeat(3 - mastery);

        const card = document.createElement('div');
        card.className = 'bg-purple-900/40 hover:bg-purple-800/60 rounded-2xl p-6 border border-purple-500/30 hover:border-cyan-400/60 transition-all cursor-pointer hover:scale-105 hover:shadow-xl hover:shadow-cyan-500/20';
        card.onclick = () => openLetterModal(letter);

        card.innerHTML = `
          <div class="flex items-start justify-between mb-2 md:mb-4">
            <div class="hangul text-4xl md:text-7xl font-black text-cyan-400">${letter.char}</div>
            <div class="text-right">
              <div class="text-lg md:text-3xl font-bold text-purple-300 mb-1">${letter.roman}</div>
              <div class="text-sm md:text-lg text-yellow-400">${stars}</div>
            </div>
          </div>
          <div class="text-xs md:text-lg text-purple-200 font-semibold mb-1 md:mb-2">${letter.sound}</div>
          <div class="text-xs md:text-sm text-purple-300 italic line-clamp-2">${letter.example}</div>
        `;

        container.appendChild(card);
      });
    }

    function renderCanvasLetterList() {
      const container = document.getElementById('canvasLetterList');
      container.innerHTML = '';

      allLetters.forEach(letter => {
        const btn = document.createElement('button');
        btn.className = 'w-full flex items-center gap-4 p-3 rounded-xl bg-purple-900/40 hover:bg-purple-800/60 transition-all text-left border border-purple-500/30 hover:border-cyan-400/60';
        btn.onclick = () => selectCanvasLetter(letter);

        btn.innerHTML = `
          <div class="hangul text-2xl md:text-4xl font-bold text-cyan-400">${letter.char}</div>
          <div class="flex-1">
            <div class="font-bold text-purple-200 text-sm md:text-lg">${letter.roman}</div>
            <div class="text-xs md:text-sm text-purple-400">${letter.sound}</div>
          </div>
        `;

        container.appendChild(btn);
      });
    }

    // MODAL
    function openLetterModal(letter) {
      currentModalLetter = letter;
      const mastery = getLetterMastery(letter.id);

      document.getElementById('modalLetter').textContent = letter.char;
      document.getElementById('modalRoman').textContent = letter.roman;
      document.getElementById('modalSound').textContent = letter.sound;
      document.getElementById('modalExplanation').textContent = letter.explanation;
      document.getElementById('modalExample').textContent = letter.example;

      const masteryContainer = document.getElementById('modalMastery');
      masteryContainer.innerHTML = '';
      for (let i = 0; i < 3; i++) {
        const star = document.createElement('span');
        star.textContent = i < mastery ? 'â­' : 'â˜†';
        masteryContainer.appendChild(star);
      }

      document.getElementById('letterModal').classList.remove('hidden');
      document.getElementById('letterModal').classList.add('flex');
    }

    function closeLetterModal() {
      document.getElementById('letterModal').classList.add('hidden');
      document.getElementById('letterModal').classList.remove('flex');
    }

    function practiceLetterFromModal() {
      if (currentModalLetter) {
        selectCanvasLetter(currentModalLetter);
        closeLetterModal();
        switchSection('canvas');
      }
    }

    // CANVAS
    function setupCanvas() {
      drawCanvas = document.getElementById('drawCanvas');
      drawCtx = drawCanvas.getContext('2d');
      guideCanvas = document.getElementById('guideCanvas');
      guideCtx = guideCanvas.getContext('2d');

      resizeCanvases();
      window.addEventListener('resize', resizeCanvases);

      drawCtx.lineWidth = 10;
      drawCtx.lineCap = 'round';
      drawCtx.lineJoin = 'round';
      drawCtx.strokeStyle = '#a855f7';

      drawCanvas.addEventListener('mousedown', startDrawing);
      drawCanvas.addEventListener('mousemove', drawLine);
      drawCanvas.addEventListener('mouseup', stopDrawing);
      drawCanvas.addEventListener('mouseout', stopDrawing);

      drawCanvas.addEventListener('touchstart', handleTouchStart);
      drawCanvas.addEventListener('touchmove', handleTouchMove);
      drawCanvas.addEventListener('touchend', stopDrawing);

      drawGuide();
    }

    function resizeCanvases() {
      const container = drawCanvas.parentElement;
      const rect = container.getBoundingClientRect();
      const size = Math.floor(Math.min(rect.width, rect.height));

      drawCanvas.width = size;
      drawCanvas.height = size;
      guideCanvas.width = size;
      guideCanvas.height = size;

      drawCanvas.style.width = size + 'px';
      drawCanvas.style.height = size + 'px';
      guideCanvas.style.width = size + 'px';
      guideCanvas.style.height = size + 'px';

      drawCtx.lineWidth = 10;
      drawCtx.lineCap = 'round';
      drawCtx.lineJoin = 'round';
      drawCtx.strokeStyle = '#a855f7';

      drawGuide();
    }

    function selectCanvasLetter(letter) {
      currentCanvasLetter = letter;
      document.getElementById('canvasLetterDisplay').textContent = letter.char;
      document.getElementById('canvasLetterRoman').textContent = letter.roman;
      document.getElementById('canvasLetterSound').textContent = letter.sound;
      document.getElementById('canvasLetterExample').textContent = letter.example;
      clearDrawing();
      drawGuide();
    }

    function drawGuide() {
      guideCtx.clearRect(0, 0, guideCanvas.width, guideCanvas.height);
      const size = guideCanvas.width;
      guideCtx.font = `bold ${size * 0.65}px Noto Sans KR`;
      guideCtx.fillStyle = 'rgba(180, 180, 180, 0.3)';
      guideCtx.textAlign = 'center';
      guideCtx.textBaseline = 'middle';
      guideCtx.fillText(currentCanvasLetter.char, size / 2, size / 2);
    }

    function startDrawing(e) {
      isDrawing = true;
      const rect = drawCanvas.getBoundingClientRect();
      const scaleX = drawCanvas.width / rect.width;
      const scaleY = drawCanvas.height / rect.height;
      const x = (e.clientX - rect.left) * scaleX;
      const y = (e.clientY - rect.top) * scaleY;
      drawCtx.beginPath();
      drawCtx.moveTo(x, y);
    }

    function drawLine(e) {
      if (!isDrawing) return;
      const rect = drawCanvas.getBoundingClientRect();
      const scaleX = drawCanvas.width / rect.width;
      const scaleY = drawCanvas.height / rect.height;
      const x = (e.clientX - rect.left) * scaleX;
      const y = (e.clientY - rect.top) * scaleY;
      drawCtx.lineTo(x, y);
      drawCtx.stroke();
    }

    function stopDrawing() {
      isDrawing = false;
    }

    function handleTouchStart(e) {
      e.preventDefault();
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent('mousedown', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      drawCanvas.dispatchEvent(mouseEvent);
    }

    function handleTouchMove(e) {
      e.preventDefault();
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent('mousemove', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      drawCanvas.dispatchEvent(mouseEvent);
    }

    function clearDrawing() {
      drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
    }

    // QUIZ
    function loadNextQuiz() {
      currentQuizLetter = allLetters[Math.floor(Math.random() * allLetters.length)];
      document.getElementById('quizLetter').textContent = currentQuizLetter.char;
      document.getElementById('quizFeedbackContainer').classList.add('hidden');

      let options = [currentQuizLetter.roman];
      while (options.length < 4) {
        const randomLetter = allLetters[Math.floor(Math.random() * allLetters.length)];
        if (!options.includes(randomLetter.roman)) {
          options.push(randomLetter.roman);
        }
      }
      options.sort(() => Math.random() - 0.5);

      const container = document.getElementById('quizOptionsContainer');
      container.innerHTML = '';

      options.forEach(option => {
        const btn = document.createElement('button');
        btn.className = 'p-4 md:p-8 bg-purple-900/40 hover:bg-purple-800/60 rounded-xl md:rounded-2xl font-bold text-xl md:text-3xl transition-all border-2 border-purple-500/30 hover:border-cyan-400/60';
        btn.textContent = option;
        btn.onclick = () => checkQuizAnswer(option, btn);
        container.appendChild(btn);
      });
    }

    async function checkQuizAnswer(answer, btn) {
      const isCorrect = answer === currentQuizLetter.roman;

      document.querySelectorAll('#quizOptionsContainer button').forEach(b => {
        b.disabled = true;
        if (b.textContent === currentQuizLetter.roman) {
          b.classList.add('bg-green-600', 'border-green-400');
        }
      });

      if (isCorrect) {
        quizCorrect++;
        btn.classList.add('bg-green-600', 'border-green-400');
        document.getElementById('quizFeedbackMessage').textContent = 'ğŸ‰ Perfetto!';
        document.getElementById('quizFeedbackMessage').className = 'text-4xl font-bold mb-4 text-green-400';
      } else {
        quizWrong++;
        btn.classList.add('bg-red-600', 'border-red-400');
        document.getElementById('quizFeedbackMessage').textContent = 'âŒ Sbagliato!';
        document.getElementById('quizFeedbackMessage').className = 'text-4xl font-bold mb-4 text-red-400';
      }

      document.getElementById('quizFeedbackDetail').textContent = `${currentQuizLetter.char} si pronuncia "${currentQuizLetter.roman}" - ${currentQuizLetter.explanation}`;
      document.getElementById('quizCorrectScore').textContent = quizCorrect;
      document.getElementById('quizWrongScore').textContent = quizWrong;
      document.getElementById('quizFeedbackContainer').classList.remove('hidden');

      await updateLetterMastery(currentQuizLetter.id, isCorrect);
    }

    // NAVIGATION
    function switchSection(sectionName) {
      document.querySelectorAll('.content-section').forEach(el => el.classList.add('hidden'));
      document.getElementById(`section-${sectionName}`).classList.remove('hidden');

      document.querySelectorAll('.section-tab').forEach(btn => {
        btn.classList.remove('bg-cyan-600', 'text-white', 'shadow-lg', 'shadow-cyan-500/30');
        btn.classList.add('bg-purple-900/40', 'text-purple-300');
      });

      const activeBtn = document.querySelector(`[data-section="${sectionName}"]`);
      if (activeBtn) {
        activeBtn.classList.remove('bg-purple-900/40', 'text-purple-300');
        activeBtn.classList.add('bg-cyan-600', 'text-white', 'shadow-lg', 'shadow-cyan-500/30');
      }
    }

    // INIT
    initializeApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c741654b1cb0e55',t:'MTc2OTk3NjU3NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>